# Elastic Load Balancer (ELB)

로드 밸런서의 주요 기능은 특정 서버에 부하가 집중되지 않도록 분산하는 것이다. On-premise의 L4 스위치와 같이 부하 분산과 더불어, 분산 대상에 대한
헬스체크, 고정 세션, SSL offload 등이 가능하다. 추가적으로 단순 부하 분산과 더불어, HTTP Header를 조작하여 전달 대상을 정하거나, SSL 인증서를 적용하여
EC2의 부하를 줄이는 등의 다양한 기능을 적용할 수 있다.

## 기본 구성

로드 밸런서는 VPC 내에 위치하며 사용자의 요청을 VPC 내의 리소스에 부하를 분산하며 다음과 같은 구성을 가진다

- 리스너
  - 외부 요청을 받아들이는 서비스 포트
  - 서비스 포트로 접속하는 요청에 대해서만 부하분산을 실행
  - 요청을 검토한 후 적절한 요청에 대해서 대상 그룹에 전달
  - L4 스위치의 Virtual Server 기능
- 대상그룹
  - 분산 및 요청을 전달할 대상을 묶은 그룹
  - L4 스위치의 Pool 기능
- 헬스체크
  - 대상 그룹에 대한 헬스 체크를 통해 대상이 요청을 받을 수 있는 상태인지 확인

## Application Load Balance(ALB)

OSI Layer 7계층에 해당하는 Application Layer의 특성을 이용하는 로드 밸런서

- HTTP, HTTPS의 특성을 주로 다루는 로드밸런서
- 단순 부하 분산과 더불어 `HTTP 헤더 정보를 이용해 부하분산`을 실시
- 즉, 헤더 값을 보고 대상그룹을 선택할 수 있다
- SSL 인증서 탑재가 가능하기에 EC2 인스턴스를 대신해서 SSL 암복화를 진행

### HTTP 를 활용한 라우팅

1. HTTP 헤더는 표준, 요청, 응답, 일반 헤더가 존재하고, ALB는 요청 헤더와 일반 헤더를 라우팅 규칙에 활용한다. 각 헤더들의 주요 항목은 다음과 같다.
   - 요청 헤더
     - Host, Cookie, User-agent, Accept 등
     - 사용자의 상태나 디바이스 관련 정보
   - 일반 헤더
     - X-Forwarded-For
2. GET, POST, PUT 과 같은 HTTP 요청 메서드를 통한 라우팅이다.
3. 요청 경로에 따른 라우팅
4. 사용자의 IP, 즉 소스 IP 에 따른 라우팅
5. 쿼리 문자열에 따른 라우팅

### ALB의 로드밸런싱 방식

앞서 언급한 라우팅 방식에 따라 대상 그룹에 대한 로드밸런싱이 진행되며 이때 로드밸런싱의 방식을 선택할 수 있다

- Round Robin
  - 기본 방식
  - 요청을 인스턴스에 순서대로 할당
  - 요청이 균등하게 분배되나, 특정 인스턴스의 처리가 지연되어 완료되지 못한 상황에는 문제가 발생할 수 있다
- Last Outstanding Requests
  - 처리되지 않은 요청을 적게 가지고 있는 인스턴스에 할당하는 방식
  - 즉, 처리 능력이 우수하거나 여유가 많은 인스턴스에 작업을 전달하는 방식

### SSL 인증서 탑재 기능

HTTPS 통신을 하기 위해서는 SSL 인증서를 통한 인증 및 SSL Handshake 를 통한 negotiation 이 진행되어야 한다.
하지만 이 작업은 리소스 소모가 크기 때문에, 온프레미스 서버에서는 L4 스위치가 그 역할을 대행한다. 즉, 사용자와 L4 스위치는 암호화 통신을 진행하고,
L4 스위치와 서버는 평문으로 통신을 하게되는데 우리는 이것을 `SSL Offload` 라고 한다.

- ALB 에서는 암호화 통신이 필요한 경우 EC2 를 대신하여 암호화 통신을 실시

### 프록시 서버로의 역할

실제 서비스를 제공하는 것은 인스턴스지만, 사용자와 통신하는 것은 ALB이다. 즉, ALB 는 사용자와 서버 중간에서 프록시 서버의 역할로 양쪽과 통신을 하게된다.
이 동작의 흐름을 살펴보면 다음과 같다

1. 사용자와 ALB 가 public ip를 통해 3-way handshake 를 진행
2. ALB 와 대상 그룹 내 인스턴스가 vpc 내 private ip를 통해 3-way handshake 를 진행
3. 이후 진행되는 요청은 사용자 -> ALB -> 서버로 전달되는 구조

### AWS Web Application Firewall(WAF) 연동

WAF 는 CloudFront, ALB, API Gateway에 적용 가능한 방확벽 서비스로, ALB 로 유입되는 웹 공격을 보호할 수 있다.

## Network Load Balance(NLB)

OSI Layer 4계층에 해당하는 Transport Layer 에서 동작하는 로드 밸런서

- TCP, UDP의 요청을 받아들여 부하분산을 진행
  - HTTP 또한 TCP 기반 프로토콜이기에 NLB 사용 가능
  - 다만 HTTP 계층이 상위 계층이기에 헤더를 해석하지 못함

7 계층을 이용하는 ALB 는 HTTP, HTTPS, WebSocket 을 이해하고 처리할 수 있지만, 그만큼 많은 리소스를 소모해야는 문제가 있다.
즉, NLB 는 상위 계층의 프로토콜을 이해할 필요없이 TCP, UDP 만 이해하면 되기에, ALB 보다 리소스 소모가 적고 따라서 더 많은 트래픽을 처리할 수 있다.

### NLB 의 로드밸런싱 방식

TCP, UDP 모두 기본적으로 아래 다섯가지에 흐름 해시 알고리즘 적용하여 대상을 선택한다. 다만 TCP의 경우 `TCP 시퀀스 번호`라는 추가적인 사항이 존재한다

- 프로토콜
- 원본 IP 주소
- 원본 포트
- 대상 IP 주소
- 대상 포트
- TCP 시퀀스 번호(TCP Only)

이 항목들에 대해 흐름 해시 알고리즘을 적용하기에, 정보가 변경된다면 새로운 요청으로 간주하여 새로운 커넥션을 생성하기 위한 로드밸런싱이 진행된다.

### 고정 IP 제공

NLB 의 가장 큰 특징은 public, private ip 모두 고정 ip 를 가진다는 것이다. ALB 는 IP가 지속적으로 변하기 때문에, ALB의 public ip를 목적지로 삼아
접근 제어를 하기엔 어려움이 존재한다. 따라서, ALB 앞단에 NLB를 두어 고정된 IP 를 제공하고 NLB는 ALB를 대상그룹으로 지정하여 서비스를 구축하는 방식을 많이 사용한다.

### Source IP NAT & Traffic Flow

ALB의 경우 프록시 서버로서의 역할을 한다. 사용자의 IP 가 ALB 를 통과하면서 NAT 하게된다는 말이다.
하지만 NLB의 경우 NAT를 진행하지 않고 Direct Server Return(DSR)에 가까운 트래픽 플로우를 보여주게 된다.
NLB를 통과한 패킷의 Source IP는 그대로 사용자의 Source IP가 되고, 서버에서 응답의 목적지는 NLB가 아닌 패킷으로 유입된 Source IP, 즉, 사용자가 된다.
NLB를 거치지 않고 Internet Gateway 를 통해 외부인터넷으로 바로 전달되기 때문에 트래픽 부담이 줄어들게 된다.

### SSL 탑재 기능(TLS)

NLB 또한 ALB와 마찬가지로 EC2 인스턴스를 대신하여 암호화 통신을 대행할 수 있다.